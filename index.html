<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>elparadisogonzalo Token dApp</title>
</head>
<body>
  <h2>ü¶ä MetaMask Token dApp</h2>

  <button id="connect">Connect Wallet</button>
  <p id="status"></p>
  <p id="ethBalance"></p>
  <p id="tokenBalance"></p>

  <h3>üì§ Send Tokens</h3>
  <input type="text" id="recipient" placeholder="Recipient address" size="50">
  <input type="text" id="amount" placeholder="Amount to send">
  <button id="send">Send Tokens</button>
  <p id="transferStatus"></p>

  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script>
    const tokenAddress = "0x4e8c73e7f243d12b7a5571200609523a4890beff";
    const tokenABI = [
      {
        "constant": true,
        "inputs": [{"name": "_owner", "type": "address"}],
        "name": "balanceOf",
        "outputs": [{"name": "balance", "type": "uint256"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "decimals",
        "outputs": [{"name": "", "type": "uint8"}],
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "symbol",
        "outputs": [{"name": "", "type": "string"}],
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          { "name": "_to", "type": "address" },
          { "name": "_value", "type": "uint256" }
        ],
        "name": "transfer",
        "outputs": [{ "name": "", "type": "bool" }],
        "type": "function"
      }
    ];

    let web3;
    let userAddress;
    let tokenContract;
    let decimals = 18;
    let symbol = "";

    async function connect() {
      if (typeof window.ethereum !== 'undefined') {
        web3 = new Web3(window.ethereum);
        try {
          await ethereum.request({ method: "eth_requestAccounts" });
          const accounts = await web3.eth.getAccounts();
          userAddress = accounts[0];
          document.getElementById("status").innerText = "‚úÖ Connected: " + userAddress;

          const ethBalance = await web3.eth.getBalance(userAddress);
          document.getElementById("ethBalance").innerText =
            "üí∞ ETH: " + web3.utils.fromWei(ethBalance, "ether");

          tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);
          decimals = await tokenContract.methods.decimals().call();
          symbol = await tokenContract.methods.symbol().call();
          const rawBalance = await tokenContract.methods.balanceOf(userAddress).call();
          const balance = rawBalance / Math.pow(10, decimals);
          document.getElementById("tokenBalance").innerText =
            "üéØ Token Balance: " + balance + " " + symbol;

        } catch (err) {
          document.getElementById("status").innerText = "‚ùå Error: " + err.message;
        }
      } else {
        document.getElementById("status").innerText = "ü¶ä MetaMask not found";
      }
    }

    async function sendTokens() {
      const recipient = document.getElementById("recipient").value;
      const amount = document.getElementById("amount").value;

      if (!recipient || !amount) {
        document.getElementById("transferStatus").innerText = "‚ö†Ô∏è Fill in all fields";
        return;
      }

      const amountInWei = web3.utils.toBN(amount * Math.pow(10, decimals));

      try {
        document.getElementById("transferStatus").innerText = "‚è≥ Sending...";
        await tokenContract.methods.transfer(recipient, amountInWei.toString()).send({ from: userAddress });
        document.getElementById("transferStatus").innerText = "‚úÖ Tokens sent to " + recipient;

        // Update balance after sending
        const newBalance = await tokenContract.methods.balanceOf(userAddress).call();
        document.getElementById("tokenBalance").innerText =
          "üéØ Token Balance: " + (newBalance / Math.pow(10, decimals)) + " " + symbol;

      } catch (err) {
        document.getElementById("transferStatus").innerText = "‚ùå Transfer failed: " + err.message;
      }
    }

    document.getElementById("connect").onclick = connect;
    document.getElementById("send").onclick = sendTokens;
  </script>
</body>
  <head>
    <meta charset="UTF-8" />
    <title>WebApp</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
