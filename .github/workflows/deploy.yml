name: üöÄ Deploy dApp to IPFS and update UD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üì¶ Install dependencies
        run: npm install
        working-directory: frontend

      - name: üõ† Build frontend
        run: npm run build
        working-directory: frontend

      - name: üì§ Upload to IPFS (via Pinata)
        id: ipfs
        run: |
          mkdir packaged
          cd frontend/dist
          zip -r ../../packaged/build.zip .
          cd ../../
          CID=$(curl -s -X POST https://api.pinata.cloud/pinning/pinFileToIPFS \
            -H "Authorization: Bearer ${{ secrets.PINATA_JWT }}" \
            -F "file=@packaged/build.zip" | jq -r '.IpfsHash')
          echo "CID=$CID" >> $GITHUB_OUTPUT
        env:
          PINATA_JWT: ${{ secrets.PINATA_JWT }}

      - name: üåê Update Unstoppable Domain
        run: |
          echo "Updating domain with CID: ${{ steps.ipfs.outputs.CID }}"
          curl -X PATCH https://api.unstoppabledomains.com/v1/domains/${{ secrets.UD_DOMAIN }}/records \
            -H "Authorization: Bearer ${{ secrets.UD_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"records": {"ipfs.html.value": "${{ steps.ipfs.outputs.CID }}"}}'
        env:
          UD_API_KEY: ${{ secrets.UD_API_KEY }}
          UD_DOMAIN: elparadisogonzalo.com
