name: "Build & Publish CodeQL Model Pack"

on:
  push:
    branches: [ main ]
    paths:
      - "codeql/**"
  workflow_dispatch:

jobs:
  build-test-publish:
    name: Build, Test & Publish Model Pack
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup CodeQL CLI
      uses: github/codeql-action/setup-codeql@v2
      with:
        version: latest

    - name: Verify CodeQL installation
      run: codeql version

    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm install
        fi

    - name: Test model pack
      run: |
        # Example: test your model pack queries
        codeql test run codeql/model-packs/elparadisogonzalo-pack

    - name: Package model pack
      run: |
        mkdir -p dist
        codeql pack create codeql/model-packs/elparadisogonzalo-pack --output=dist

    - name: Publish model pack to GitHub
      env:
        CODEQL_PACK_TOKEN: ${{ secrets.CODEQL_PACK_TOKEN }}
      run: |
        codeql pack publish codeql/model-packs/elparadisogonzalo-pack \
          --version=1.0.0 \
          --registry=github \
          --github-auth-token="$CODEQL_PACK_TOKEN"

